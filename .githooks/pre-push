#!/bin/bash

# Do not change order of tool
# 1. pint
# 2. linter
# 3. rector
# 4. tests

# --------------------------------------------------------------------------
# Pint
# --------------------------------------------------------------------------
echo "[ pre-push ] ðŸ”„ Running Pint - $(date '+%H:%M:%S')"
./vendor/bin/pint --parallel
echo "[ pre-push ] âœ… Pint finished - $(date '+%H:%M:%S')"

# --------------------------------------------------------------------------
# Migration linter
# --------------------------------------------------------------------------
echo "[ pre-push ] ðŸ”„ Running Migration linter - $(date '+%H:%M:%S')"
php artisan migrate:lint --compact
echo "[ pre-push ] âœ… Migration linter finished - $(date '+%H:%M:%S')"

# --------------------------------------------------------------------------
# Rector
# --------------------------------------------------------------------------
echo "[ pre-push ] ðŸ”„ Running Rector - $(date '+%H:%M:%S')"
./vendor/bin/rector
echo "[ pre-push ] âœ… Rector finished - $(date '+%H:%M:%S')"

# --------------------------------------------------------------------------
# Tests
# --------------------------------------------------------------------------
echo "[ pre-push ] ðŸ”„ Running Tests - $(date '+%H:%M:%S')"
php artisan test --parallel
echo "[ pre-push ] âœ… Tests finished - $(date '+%H:%M:%S')"

if [ $? -ne 0 ]; then
  exit 1
fi

# Get the branch being pushed
current_branch=$(git symbolic-ref --short HEAD)

# Define allowed branch patterns
allowed_patterns=("^feature/" "^bugfix/" "^hotfix/" "^improve/" "^staging/" "^master$")

# Check if the branch name matches any of the allowed patterns
for pattern in "${allowed_patterns[@]}"; do
  if [[ "$current_branch" =~ $pattern ]]; then
    exit 0
  fi
done

# If no match, block the push
echo "Error: Branch '$current_branch' is not allowed to push. Allowed patterns are: ${allowed_patterns[*]}"
exit 1
