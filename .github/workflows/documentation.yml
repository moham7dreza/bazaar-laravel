name: Documentation Validation

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-documentation:
    runs-on: ubuntu-latest
    name: Validate Task Documentation

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
          coverage: none

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Copy environment file
        run: cp .env.testing.example .env.testing

      - name: Run documentation validation tests
        run: php artisan test --filter=documentation

      - name: Check for documentation file
        id: check_docs
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "Branch: $BRANCH_NAME"

          # Skip for main/master/develop branches
          if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "master" || "$BRANCH_NAME" == "develop" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Skip if not a feature/bugfix/enhancement branch
          if [[ ! "$BRANCH_NAME" =~ ^(feature|bugfix|enhancement|hotfix)/ ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract Jira ticket
          JIRA_TICKET=$(echo "$BRANCH_NAME" | grep -oP '[A-Z]+-\d+' | head -1 || echo "")

          if [ -z "$JIRA_TICKET" ]; then
            echo "::warning::Could not extract Jira ticket from branch name: $BRANCH_NAME"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "jira_ticket=$JIRA_TICKET" >> $GITHUB_OUTPUT

          # Check if documentation exists
          DOC_FILES=$(find docs/features -name "${JIRA_TICKET}-*.md" 2>/dev/null || echo "")

          if [ -z "$DOC_FILES" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::error::Documentation not found for $JIRA_TICKET"
            exit 1
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "doc_file=$DOC_FILES" >> $GITHUB_OUTPUT
            echo "::notice::Documentation found: $DOC_FILES"
          fi

      - name: Comment on PR (if documentation missing)
        if: failure() && github.event_name == 'pull_request' && steps.check_docs.outputs.exists == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ö†Ô∏è Documentation Missing

              This PR is missing required task documentation for **${{ steps.check_docs.outputs.jira_ticket }}**.

              ### How to add documentation:

              **Option 1: Using AI (Recommended)**
              1. Copy the AI prompt from \`.github/DOCUMENTATION_AI_PROMPT.md\`
              2. Paste it into GitHub Copilot or your AI assistant
              3. Review and save the generated documentation

              **Option 2: Manual Creation**
              \`\`\`bash
              php artisan make:task-doc
              \`\`\`

              **Option 3: Using Template**
              Copy \`docs/templates/TASK_DOCUMENTATION_TEMPLATE.md\` and fill it in.

              üìÅ Save the file as: \`docs/features/${{ steps.check_docs.outputs.jira_ticket }}-description.md\`

              Once added, commit and push the documentation with your changes.
              `
            })

